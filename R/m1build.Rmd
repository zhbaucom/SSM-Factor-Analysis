---
title: "Untitled"
output: html_document
---

```{r}
library(tidyverse)
source('functions/ffbsJoint.R')
```



## N > 1 all positions of G

```{r}
N <- 5
TT <-10
Q <- 2
K <- 3
mu_qs <- 0
var_qs <- 10
sigeps2 <- 1
gvec <- seq(0, 1, length.out = K)

G <- c(
  rev(gvec), (gvec)
) %>%
  matrix(K, Q)



ITSKEEPER <- matrix(nrow = 500, ncol = 500)

# for(j in 1:500){
  
  
  
  etas <- rnorm(TT*N*Q) %>%
    array(dim = c(TT,Q,N))
  
  epsilon <- rnorm(TT*N*K, sd = sqrt(sigeps2)) %>%
    array(dim = c(K,TT,N))
  
  alphas <- apply(etas, c(2,3), cumsum)
  alphas <- lapply(1:N, function(i)alphas[,,i])
  
  
  y <- lapply(1:N, function(i){
    tcrossprod(G, alphas[[i]]) + epsilon[,,i]
  })
  

  
  
  G.star <- G
  G.star[1,1] <- 0
  
  its <- 500
  G.track <- array(dim = c(dim(G), its))
  
  k <- 1
  q <- 2
  qtil <- which((1:Q) != q)
  
  

  # G <- G.star
  # y <- y[[1]]
  # W <- diag(1, 2, 2)
  # V <- diag(1, 3, 3)
  # m0 <- 0
  # C0 <- diag(10, 2, 2)
  
  
  for(i in 1:its){

    for(k in 1:K){
      yk <- lapply(y, function(x)x[k,])
      Galpha <- lapply(1:N, function(ind) G.star[k,] * t(alphas[[ind]]))
      
      YGA <- lapply(1:N, function(ind) yk[[ind]] - t(Galpha[[ind]]))
      for(q in 1:Q){
        
        
        
        
        
        
        qtil <- which((1:Q) != q)
        
        aq <- lapply(1:N, function(ind)alphas[[ind]][,q])
        
        numer <- lapply(1:N, function(ind)sum(aq[[ind]] * YGA[[ind]][,qtil])) %>%
          unlist() %>%
          sum
        
        denom <- lapply(1:N, function(ind)alphas[[ind]][,q]^2) %>%
          unlist() %>%
          sum
        
        
        # sum(aq * YGA[,qtil])
        
        
        gskMean <- (sigeps2 * mu_qs + var_qs  * numer) / (sigeps2 + var_qs * denom)
        
        gskVar <- sigeps2 * var_qs / (sigeps2 + var_qs * denom)
        
        
        G.star[k, q] <- rnorm(1, gskMean, sqrt(gskVar))
      }
    }
    
    G.track[,,i] <- G.star
  }
  
#   ITSKEEPER[,j] <- G.track[1,1,]
# 
# }
kp <- 1
qp <- 2


for(kp in 1:K){
  for(qp in 1:Q){
    plot(
      G.track[kp,qp,], 
      main = paste(
        "(", 
        paste(round(quantile(G.track[kp,qp,], c(0.025, 0.975)), 3), collapse = ", "),
        ")", 
        sep = ""
      )
    )
    abline(h = G[kp,qp])
  }
}




# colMeans(ITSKEEPER) %>%
#   hist()
# 
# apply(ITSKEEPER, 2, quantile, c(.025, 0.975)) %>%
#   apply(2, function(x) x[1] < 1 & x[2] > 1) %>%
#   mean()



```