---
title: "Untitled"
output: html_document
---

```{r}
library(tidyverse)
source('functions/ffbsJoint.R')
```



# N = 1 all G matrix

```{r}

TT <- 50
N <- 1
Q <- 3
K <- 6
mu_qs <- 0
var_qs <- 10
sigeps2 <- 1
gvec <- seq(0, 1, length.out = K)

G <- c(
  rev(gvec), (gvec), runif(K, 0, 1)
) %>%
  matrix(K, Q)

G.track <- array(dim = c(dim(G), its))

G.star <- G.prior <- G

etas <- rnorm(TT*1*Q) %>%
  matrix(TT, Q)

epsilon <- rnorm(TT*1*K, sd = sqrt(sigeps2)) %>%
   matrix(K, TT)

alphas <- apply(etas, 2, cumsum) %>% t()

y <- G %*% alphas + epsilon



alpha.star <- alphas
i <- 1
k <- 1
q <- 1


alpha.track <- array(dim = c(Q, TT, its))
ata <-  solve(tcrossprod(alphas) + diag(var_qs, Q, Q))
mu.g <- (G.prior + tcrossprod(y, alphas)) %*% ata  

alphas %*% y[6,]  
  for(i in 1:its){
    
    
    
    G.track[,,i] <- G.star <- lapply(1:K, function(k){
      mvtnorm::rmvnorm(1, mean = mu.g[k,], sigma = ata)
    }) %>%
      do.call("rbind", .)
    
  }
  
#   ITSKEEPER[,j] <- G.track[1,1,]
# 
# }
kp <- 1
qp <- 2


for(kp in 1:K){
  for(qp in 1:Q){
    plot(
      G.track[kp,qp,], 
      main = paste(
        "(", 
        paste(round(quantile(G.track[kp,qp,], c(0.025, 0.975)), 3), collapse = ", "),
        ")", 
        sep = ""
      )
    )
    abline(h = G[kp,qp])
  }
}




# colMeans(ITSKEEPER) %>%
#   hist()
# 
# apply(ITSKEEPER, 2, quantile, c(.025, 0.975)) %>%
#   apply(2, function(x) x[1] < 1 & x[2] > 1) %>%
#   mean()

G.star

```
