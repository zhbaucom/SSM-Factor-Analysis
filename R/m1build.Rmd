---
title: "Untitled"
output: html_document
---

```{r}
library(tidyverse)
source('functions/ffbsJoint.R')
```


## Verifying posterior for single gsk fixing the alphas as the true values

```{r}
TT <- 50
N <- 1
Q <- 2
K <- 3
mu_qs <- 0
var_qs <- 10
sigeps2 <- 1
gvec <- seq(0, 1, length.out = K)

G <- c(
  rev(gvec), (gvec)
) %>%
  matrix(K, Q)


ITSKEEPER <- matrix(nrow = 500, ncol = 500)
for(j in 1:500){
  
  
  
  etas <- rnorm(TT*N*Q) %>%
    array(dim = c(TT,Q,N))
  
  epsilon <- rnorm(TT*N*K, sd = sqrt(sigeps2)) %>%
    array(dim = c(K,TT,N))
  
  alphas <- apply(etas, c(2,3), cumsum)
  
  G_alpha <- tcrossprod(G, alphas[,,1])
  
  y <- G_alpha + epsilon[,,1]
  
  
  G.star <- G
  G.star[1,1] <- 0
  
  its <- 500
  G.track <- array(dim = c(dim(G), its))
  
  k <- 1
  q <- 1
  qtil <- which((1:Q) != q)
  
  yk <- y[k,]
  alphasN <-  t(alphas[,,1])
  
  
  for(i in 1:its){
    
    Galpha <- G.star[k,] * t(alphas[, ,1])
    
    YGA <- yk - t(Galpha)
    
    
    aq <- alphas[,q,1]
    
    sum(aq * YGA[,qtil])
    
    
    gskMean <- (sigeps2 * mu_qs + var_qs  * sum(aq * YGA[,qtil])) / (sigeps2 + var_qs * sum(alphas[,q,1]^2))
    
    gskVar <- sigeps2 * var_qs / (sigeps2 + var_qs * sum(alphas[,q,1]^2))
    
    
    G.track[,,i] <- G.star[k, q] <- rnorm(1, gskMean, sqrt(gskVar))
  }
  ITSKEEPER[,j] <- G.track[1,1,]

}


plot(G.track[1,1,], main = paste("(", paste(round(quantile(G.track[1,1,], c(0.025, 0.975)), 3), collapse = ", "), ")", sep = ""))
abline(h = G[1,1])


colMeans(ITSKEEPER) %>%
  hist()

apply(ITSKEEPER, 2, quantile, c(.025, 0.975)) %>%
  apply(2, function(x) x[1] < 1 & x[2] > 1) %>%
  mean()

```

